openapi: 3.1.0
info:
  title: Forma Health OpenAPI Spec
  description: >-
    This API should be allow the ios and android frontends to connect to the ruby backend
  version: 1.0.0
servers:
  - url: https://api-web-a7ya.onrender.com/api/v1
tags:
  - name: Test
    description: okta test api call
    externalDocs:
        description: Find out more
        url: https://www.formahealth.io/
  - name: Care Teams
    description: groups including one patient and optional caregivers
  - name: Topics
    description: define what events are tracked and what is collected for each
  - name: Observations
    description: represent an event associated with a topic
  - name: Medications
    description: medications can be considered a special case of topics/observations but are handled separately by the front end
paths:
  /test:
    get:
      tags:
        - Test
      summary: Test whether okta login is functional
      responses:
        '200': 
          description: success
          content: 
            application/json:
              schema:
                $ref: '#/components/schemas/TestSuccess'
        '401': 
          $ref: '#/components/responses/Unauthorized'
      security:
        - token_auth: []
  /care_teams:
    get:
      tags:
        - Care Teams
      summary: Get the current user's list of care teams
      responses:
        '200':
          description: success
          content:
            application/json:
              schema:
                type: array
                items: 
                  $ref: '#/components/schemas/CareTeam'
        '401': 
          $ref: '#/components/responses/Unauthorized'
      security:
        - token_auth: []
  /topics:

  /observations:
    get:
      tags: 
        - Observations
      parameters:
        - in: query
          name: care_team
          schema: 
            type: string
          description: The id of the care team to get observations with
      summary: Get the observations associated with a care team
      responses:
        '200':
          description: success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Observation'
        '401':
          $ref: '#/components/responses/Unauthorized'
      security:
        - token_auth: []
    post:
      tags: 
        - Observations
      summary: Create a new structured observation directly. Generated by form filled on app.
      parameters:
        - in: query
          name: care_team
          schema:
            type: string
      requestBody:
        description: Structured observation generated by frontend. id field should be generated by the backend when the observation is received.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Observation'
            examples:
              seizure:
                description: A simple seizure example with duration and notes fields
                value:
                  time: 1709678495
                  duration: 75
                  notes: very painful
                  author: as90h87a987dgf98
                  subject: a90sd8g9as8dfg9a8s7df98
                  topic:
                    topicId: a98sdgas98d7as89ddg
                    careteamVersion: as90d8g7as9d8g9sd8
      responses:
        '200':
          description: 'success'
        '401':
          $ref: '#/components/responses/Unauthorized'
      security:
        - token_auth: []
  /freeformObservations:
    get:
      tags:
        - Observations
      parameters:
        - in: query
          name: care_team
          schema:
            type: string
          description: The id of the care team to get freeform observations with
      summary: Get freeform observations associated with a care team
      responses:
        '200':
          description: success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FreeformObservation'
        '401':
          $ref: '#/components/responses/Unauthorized'
      security:
        - token_auth: []
    post:
      tags:
        - Observations
      parameters:
        - in: query
          name: care_team
          schema: 
            type: string
          description: Care Team ID
      requestBody:
        description: Freeform observation mainly requires spoken input.
        required: true
        content:
          application/json:
            schema: 
              $ref: '#/components/schemas/FreeformObservation'
            examples:
              seizure:
                description: A simple seizure created by speech to text
                value:
                  freeformInput: Johnny had a seizure. It was a four out of ten and lasted five minutes.
                  time: 1709679778
                  timezoneOffset: -8
                  author: a9s8dga7d9g87a9d
                  subject: a9s8dghy7as987h987a987
      responses:
        '200':
          description: 'success'
        '401':
          $ref: '#/components/responses/Unauthorized'
      summary: Create a new freeform observation. The backend should send the raw data to LLM for processing and generation of structured observations.
      
      security:
        - token_auth: []
  /medications:
    get:
      tags:
        - Medications
      parameters:
        - in: query
          name: care_team
          schema: 
            type: string
          description: Care Team ID
      summary: Get medications associated with a care team
      responses:
        '200':
          description: success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Medication'
        '401':
          $ref: '#/components/responses/Unauthorized'
      security:
        - token_auth: []
  /medicationLogs:
    get:
      tags:
        - Medications
      parameters:
        - in: query
          name: care_team
          schema: 
            type: string
      summary: Get medication logs associated with a care team
      responses:
        '200':
          description: success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MedicationLog'
        '401':
          $ref: '#/components/responses/Unauthorized'
      security:
        - token_auth: []
components:
  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/TestFailure'
  schemas:
    FreeformObservation:
      type: object
      properties:
        id: 
          type: string
        freeformInput:
          type: string
        time: 
          type: integer
          format: int64
          description: unix seconds
        timezoneOffset:
          type: integer
          format: int32
        author: 
          type: string
        subject:
          type: string
      examples:
        - 
          - id: as9d8gasd9g87ags98d79
            freeformInput: Johnny had a seizure. It was a four out of ten and lasted five minutes.
            time: 1709679778
            timezoneOffset: -8
            author: a9s8dga7d9g87a9d
            subject: a9s8dghy7as987h987a987
    Observation:
      type: object
      properties:
        id:
          type: string
        time: 
          type: integer
          format: int64
          description: UTC timestamp in seconds
        duration:
          type: number
          format: double
        scale: 
          $ref: '#/components/schemas/InputScale'
        scaleValue:
          type: number
          format: double
        tags:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              keyword:
                type: string
        notes: 
          type: string
        author:
          type: string
        freeformObservation:
          type: string
        subject: 
          type: string
        topic: 
          type: object
          properties:
            topicId: 
              type: string
            careteamVersion:
              type: string
      examples:
        -
          - id: a9sd8fga98sg7as98g7d98d
            time: 1709678495
            duration: 75
            scale: 
              title: Severity
              bins:
                - range: [0, 0]
                  title: None
                  paletteSwatch: blue
                - range: [1, 3]
                  title: Mild
                  paletteSwatch: green
                - range: [4, 7]
                  title: Moderate
                  paletteSwatch: yellow
                - range: [8, 10]
                  title: Severe
                  paletteSwatch: red
            scaleValue:
              4
            tags:
              - id: asd9f78as9df7asd98f
                keyword: Lack of sleep
              - id: ad90fh8sdh9f8h7s9a
                keyword: Took advil
            notes: This seizure was not too bad
            author: asd9f80a6sd98g76asd8og
            freeformObservation: null
            subject: a9sd8ga9s8dd8g8sdfa
            topic:
              topicId: a98sdgas98d7as89ddg
              careteamVersion: as90d8g7as9d8g9sd8

    User:
      type: object
      properties:
        id: 
          type: string
          examples: [asd98f76as8dfads6af986sdf897ad6y7tfa]
        first_name:
          type: string
          examples: [Murray]
        last_name:
          type: string
          examples: [Kornelsen]
        role: 
          type: string
          examples: [Patient]
        symbol:
          $ref: '#/components/schemas/Symbol'
    CareTeam:
      type: object
      properties:
        id:
          type: string
          examples: [a9sd87fa9sd8a98fa9sd8fa9]  
        patient:
          $ref: '#/components/schemas/User'
        caregivers:
          type: array
          items:
            $ref: '#/components/schemas/User'
          examples: 
            - []
        studies:
          type: array
          items:
            $ref: '#/components/schemas/Study'
        topics:
          type: array
          items:
            $ref: '#/components/schemas/Topic'
        configs:
          type: array
          items:
            type: object
            properties:
              id: 
                type: string
              effective_date:
                type: string
                format: date-time
              version: 
                type: integer
              change_reason:
                type: string
            examples: 
              - 
                - id: 198231987298as89df7a98fd7aa98d
                  effective_date: 1900-01-01T00:00:00.000Z
                  version: "1.0"
                  change_reason: Initial version
                - id: z98xcvz98xc7v89z7v
                  effective_date: 2024-01-01T00:00:00.000Z
                  version: "2.0"
                  change_reason: Updated seizures topic
    Topic:
      type: object
      properties:
        id: 
          type: string
          examples: [a0sd7f6a980sdf698a7s6f0a897dfa]
        care_team_config_id:
          type: string
          examples: [198231987298as89df7a98fd7aa98d]
        title: 
          type: string
          examples: [Seizures]
        description:
          type: string
          examples: [Records observations related to seizures]
        observationInputs:
          type: array
          items:
            $ref: '#/components/schemas/ObservationInputIndex'
          examples:
            -
              - id: as0df86as0dfyasd09fa0
                inputType: dateTime
                inputDateTime:
                  title: When
              - id: gf79das79a6sd79faasdf
                inputType: duration
                inputDuration:
                  title: Duration
                  units: minutesSeconds
                  unitsIncrement: 1
              - id: ha8d9786hf8978dfs
                inputType: scale
                inputScale:
                  title: Severity
                  bins:
                    - range: [0, 0]
                      title: None
                      paletteSwatch: blue
                    - range: [1, 3]
                      title: Mild
                      paletteSwatch: green
                    - range: [4, 7]
                      title: Moderate
                      paletteSwatch: yellow
                    - range: [8, 10]
                      title: Severe
                      paletteSwatch: red
              - id: hgf9ad78df78f6sd87f
                inputType: tags
                inputTags:
                  title: Triggers
                  tags:
                    - id: zx987cv987zvxc
                      keyword: Took Advil
                    - id: 918272349798aadfs
                      keyword: Exercise
                    - id: asd98f7asd9f8asdf
                      keyword: Lack of sleep
              - id: a9sd8g9sdf7asd98fa
                inputType: notes
                inputNotes:
                  title: Notes
        observationVisualizations:
          type: array
          items:
            type: string
            enum: 
              - durationAverageBar
              - scaleAllBinsStackedBar
              - scaleEachBinBar
              - scaleRangeBar
              - tagEachBar
        topicCard:
          $ref: '#/components/schemas/TopicCard'
        topicSchedule:
          $ref: '#/components/schemas/TopicSchedule'
        subject:
          type: string
          examples: [a9s8df7as98df7as9df7as89fdasf]
    ObservationInputIndex:
      type: object
      properties:
        id: 
          type: string
        inputType:
          type: string
          enum:
            - dateTime
            - duration
            - scale
            - tags
            - notes
        inputDateTime:
          type: object
          properties:
            title:
              type: string
        inputDuration:
          type: object
          properties:
            title:
              type: string
            units:
              type: string
              enum:
                - minutesSeconds
                - hoursMinutes
                - daysHours
            unitsIncrement:
              type: integer
              format: int32
              examples: [1]
        inputScale:
          $ref: '#/components/schemas/InputScale'
        inputTags:
          type: object
          properties:
            title:
              type: string
            tags:
              type: array
              items:
                type: object
                properties:
                  id: 
                    type: string
                  keyword:
                    type: string
        inputNotes:
          type: object
          properties:
            title:
              type: string
    InputScale:
      type: object
      properties:
        title:
          type: string
        bins:
          type: array
          items:
            type: object
            properties:
              range: 
                type: array
                items:
                  type: integer
              title:
                type: string
              paletteSwatch: 
                type: string
    TopicCard:
      type: object
      properties:
        title:
          type: string
          examples: [Seizures]
        symbol: 
          $ref: '#/components/schemas/Symbol'
        paletteSwatch: 
          type: string
          examples: [red]
        isBackgroundLatestScaleValue:
          type: boolean
          examples: [false]
        contentTypeCenter:
          $ref: '#/components/schemas/TopicCardContentType'
        contentTypeBottomLeading:
          $ref: '#/components/schemas/TopicCardContentType'
        contentTypeBottomTrailing:
          $ref: '#/components/schemas/TopicCardContentType'
      
    TopicCardContentType:
      type: string
      enum:
        - chartObservationCounts
        - lastScaleValue
        - scaleSlider
        - timeOfLastObservation
        - timeElapsedFromLastObservation
        - timeElapsedBetweenObservationsAveraged
        - none
      examples: [timeOfLastObservation]
    TopicSchedule:
      type: object
      properties:
        isScheduled:
          type: boolean
          examples: [true]
        scheduledTimes:
          type: array
          items:
            type: string
            format: time
            examples: [14:34:00]
        scheduledDays:
          type: array
          items:
            type: string
            format: dayOfWeek
            examples: 
              - [Monday, Wednesday]
        isNotifications:
          type: boolean
          examples: [false]
        isNotificationsTimeSensitive: 
          type: boolean
          examples: [false]
        isLiveEvents:
          type: boolean
          examples: [false]
        isStaleLogging:
          type: boolean
          examples: [false]
        staleLogging:
          type: string
          format: duration
          examples: [1234567]
    Study:
      type: object
      properties:
        id:
          type: string
          examples: [679z8x76cv8976z89g6z98s7df690sd67dfa]
        name: 
          type: string
          examples: [Seizures]
    Symbol:
      type: object
      properties:
        style:
          type: string
          examples: [emoji]
          enum:
            - text
            - sfSymbol
            - emoji
            - photoLibrary
            - camera
        paletteSwatch:
          type: string
          examples: [red]
        opacity:
          type: number
          format: double
          examples: [1.0]
        valueText: 
          type: string
          examples: [Aa]
        valueEmoji:
          type: string
          examples: [😀]
        valueSFSymbol:
          type: string
          examples: [arrow.right]
        valueImage: 
          type: string
          examples: [abc.png]
        valueImageColorHex:
          type: string
          examples: ["0x3456789A"]
    Medication:
      type: object
      properties:
        id:
          type: string
        isNotifications:
          type: boolean
        name: 
          type: string
        nickname: 
          type: string
        prescriptions:
          type: array
          items:
            $ref: '#/components/schemas/MedicationPrescription'
        symbol:
          $ref: '#/components/schemas/Symbol'
        subject:
          type: string
    MedicationPrescription:
      type: object
      properties:
        id:
          type: string
        date: 
          type: integer
          format: int64
        dosage:
          type: string
        dosageDirections:
          type: string
        schedule:
          type: object
          properties:
            frequency:
              type: string
              enum: 
                - none
                - daily
                - everyXDays
                - specificWeekdays
                - asNeeded
            scheduledTimes:
              type: array
              items:
                type: string
                format: time
            scheduledDays:
              type: array
              items:
                type: string
            everyXDays:
              type: integer
              format: int32
        scheduleSummary:
          type: string
        idPrescribedBy:
          type: string
        idAuthor: 
          type: string
        lastUpdated:
          type: integer
          format: int64
    MedicationLog: 
      type: object
      properties:
        id:
          type: string
        adherence:
          type: string
          enum:
            - taken
        date: 
          type: string
          format: Local Date/Time
        lastUpdated: 
          type: integer
          format: int64
        prescriptionID:
          type: string
          description: ID of prescription from which log was generated.
        author: 
          type: string
          description: ID of medication log author
        medication:
          type: string
          description: ID of medication
    TestSuccess:
      type: object
      properties: 
        test: 
          type: string
          examples: [success]
        okta_uid: 
          type: string
          examples: [as907fhoh41ofh]
    TestFailure:
      type: object
      properties:
        errors:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
                examples: [unauthorized]
              status:
                type: integer
                format: int32
                examples: [401]
              detail:
                type: string
                examples: [Authorization is required]
  examples:
    
  securitySchemes:
    token_auth:
      type: http
      scheme: bearer
      